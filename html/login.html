<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Iniciar o Crear Cuenta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
</head>
<body>

  <!-- ENCABEZADO -->
  <header>
    <img src="../img/Logo-Futbuseras-FC.jpg" alt="Logo Futbuseras FC" class="logo-header" />
    <h1>Inicia sesión o crea tu cuenta</h1>
    <div class="pelota-wrapper">
      <div class="pelota-container">
        <div class="estela estela-1"></div>
        <div class="estela estela-2"></div>
        <div class="estela estela-3"></div>
        <img src="../img/pelota.png" alt="Pelota" class="pelota" />
      </div>
    </div>
    <p class="lema">"Juega con pasión, compra con convicción"</p>
  </header>

  <!-- LOGIN -->
  <section>
    <h2>Ingresa a tu cuenta</h2>
    <form id="form-login">
      <input type="email" id="loginEmail" placeholder="Correo" required />
      <input type="password" id="loginClave" placeholder="Contraseña" required minlength="6" />
      <button type="submit">Iniciar sesión</button>
    </form>
    <p style="text-align:center;"><a href="#" id="recuperar-link">¿Olvidaste tu contraseña?</a></p>
  </section>

  <!-- RECUPERAR CONTRASEÑA -->
  <section id="recuperar-section" style="display: none;">
    <h2>Recuperar contraseña</h2>
    <form id="form-recuperar">
      <input type="email" id="recuperarEmail" placeholder="Ingresa tu correo" required />
      <button type="submit">Recuperar</button>
    </form>
    <p id="mensaje-recuperar" style="color: green; text-align: center;"></p>
  </section>

  <!-- CREAR CUENTA -->
  <section>
    <h2>¿No tienes cuenta? Crea una</h2>
    <form id="form-crear-cuenta">
      <input type="text" id="rut" placeholder="RUT (Ej: 12345678-9 o 12345678-K)" maxlength="10" required />
      <input type="text" id="nombre" placeholder="Nombre" required />
      <input type="text" id="apellido" placeholder="Apellido" required />
      <input type="email" id="correoNuevo" placeholder="Correo electrónico" required />
      <input type="tel" id="telefono" placeholder="Teléfono" required pattern="[0-9]+" maxlength="15" />
      <input type="password" id="claveNueva" placeholder="Crea una contraseña" required minlength="6" />
      <button type="submit">Crear cuenta</button>
    </form>
    <p id="mensaje-usuario" style="color: #ff00cc; text-align: center;"></p>
  </section>

  <!-- BOTÓN REGRESAR -->
  <div class="btn-regresar">
    <a href="../index.html">← Regresar al Inicio</a>
  </div>

  <!-- SCRIPT -->
  <script>
    const usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];

    function validarRUT(rut) {
      return /^\d{7,8}-[\dkK]$/.test(rut);
    }

    function soloLetras(valor) {
      return /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(valor);
    }

    function tieneNumerosConsecutivos(texto) {
      for (let i = 0; i < texto.length - 2; i++) {
        const a = texto.charCodeAt(i);
        const b = texto.charCodeAt(i + 1);
        const c = texto.charCodeAt(i + 2);
        if (esNumero(texto[i]) && esNumero(texto[i + 1]) && esNumero(texto[i + 2])) {
          if (b === a + 1 && c === b + 1) return true;
        }
      }
      return false;
    }

    function esNumero(c) {
      return !isNaN(c) && c >= '0' && c <= '9';
    }

    function esLetra(c) {
      return /^[a-zA-Z]$/.test(c);
    }

    // LOGIN
    document.getElementById("form-login").addEventListener("submit", function (e) {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value.trim();
      const clave = document.getElementById("loginClave").value.trim();
      const usuario = usuarios.find(u => u.correo === email && u.clave === clave);
      if (usuario) {
        localStorage.setItem("usuarioActivo", JSON.stringify(usuario));
        window.location.href = "pago.html";
      } else {
        alert("Correo o contraseña incorrectos.");
      }
    });

    // CREAR CUENTA
    document.getElementById("form-crear-cuenta").addEventListener("submit", function (e) {
      e.preventDefault();
      const rut = document.getElementById("rut").value.trim();
      const nombre = document.getElementById("nombre").value.trim();
      const apellido = document.getElementById("apellido").value.trim();
      const correo = document.getElementById("correoNuevo").value.trim();
      const telefono = document.getElementById("telefono").value.trim();
      const clave = document.getElementById("claveNueva").value.trim();
      const mensaje = document.getElementById("mensaje-usuario");

      if (!validarRUT(rut)) {
        mensaje.textContent = "Formato de RUT inválido.";
        return;
      }

      if (!soloLetras(nombre) || !soloLetras(apellido)) {
        mensaje.textContent = "Nombre y Apellido solo deben contener letras.";
        return;
      }

      if (!/^\d{9,15}$/.test(telefono)) {
        mensaje.textContent = "El teléfono debe contener solo números (entre 9 y 15 dígitos).";
        return;
      }

      if (tieneNumerosConsecutivos(clave)) {
        mensaje.textContent = "";
        alert("La contraseña contiene números consecutivos. Usa una más segura.");
        return;
      }

      if (usuarios.find(u => u.rut.toLowerCase() === rut.toLowerCase() || u.correo.toLowerCase() === correo.toLowerCase())) {
        mensaje.textContent = "Usuario ya existe. Recupera tu clave.";
        return;
      }

      const nuevoUsuario = { rut, nombre, apellido, correo, telefono, clave };
      usuarios.push(nuevoUsuario);
      localStorage.setItem("usuarios", JSON.stringify(usuarios));
      localStorage.setItem("usuarioActivo", JSON.stringify(nuevoUsuario));

      mensaje.textContent = "Cuenta creada con éxito. Redirigiendo al pago...";
      setTimeout(() => {
        window.location.href = "pago.html";
      }, 1500);
    });

    // Recuperar clave
    document.getElementById("recuperar-link").addEventListener("click", function (e) {
      e.preventDefault();
      document.getElementById("recuperar-section").style.display = "block";
      window.scrollTo(0, document.body.scrollHeight);
    });

    document.getElementById("form-recuperar").addEventListener("submit", function (e) {
      e.preventDefault();
      const emailRecuperar = document.getElementById("recuperarEmail").value.trim();
      const mensajeRecuperar = document.getElementById("mensaje-recuperar");

      const usuario = usuarios.find(u => u.correo.toLowerCase() === emailRecuperar.toLowerCase());
      if (usuario) {
        mensajeRecuperar.style.color = "green";
        mensajeRecuperar.textContent = `Tu contraseña es: ${usuario.clave}`;
      } else {
        mensajeRecuperar.style.color = "red";
        mensajeRecuperar.textContent = "Correo no encontrado. Verifica o crea una cuenta.";
      }
    });
  </script>
</body>
</html>
